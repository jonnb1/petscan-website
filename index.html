<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PetScan AI</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background-color:#f7f7f7; }
    header { background-color: #0a5c75; color:#fff; padding: 1rem; text-align:center; }
    main { max-width: 800px; margin: 2rem auto; padding: 1rem; background-color:#fff; border-radius:8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1, h2 { margin-top:0; }
    label { display:block; margin-top:1rem; }
    select, textarea, input[type=file] { width:100%; padding: 0.5rem; margin-top:0.25rem; }
    .concerns { display:flex; flex-wrap: wrap; gap: 0.5rem; margin-top:0.5rem; }
    .concerns label { display: flex; align-items:center; gap:0.25rem; font-size: 0.9rem; }
    button { margin-top:1rem; padding: 0.5rem 1rem; background-color:#0a5c75; color:white; border:none; border-radius:4px; cursor:pointer; }
    .result { margin-top:2rem; padding:1rem; border-radius:8px; background-color:#f0f4f5; border:1px solid #ccc; display:none; }
    footer { text-align:center; margin-top:2rem; padding:1rem 0; color:#777; }
  </style>
</head>
<body>
<header>
  <h1>PetScan AI</h1>
  <p>AI-powered triage for your pets (not a diagnosis).</p>
</header>
<main>
  <h2>Run a Scan</h2>
  <form id="scan-form">
    <label for="scan-type">Scan Type:</label>
    <select id="scan-type" required>
      <option value="coat">Coat / Skin</option>
      <option value="gait">Gait</option>
      <option value="breathing">Breathing</option>
      <option value="hydration">Hydration</option>
      <option value="poop">Stool / Poop</option>
    </select>
    <label>Common concerns:</label>
    <div class="concerns">
      <label><input type="checkbox" value="Limping / trouble walking"> Limping / trouble walking</label>
      <label><input type="checkbox" value="Not eating / reduced appetite"> Not eating / reduced appetite</label>
      <label><input type="checkbox" value="Vomiting"> Vomiting</label>
      <label><input type="checkbox" value="Diarrhea"> Diarrhea</label>
      <label><input type="checkbox" value="Lethargy / low energy"> Lethargy / low energy</label>
      <label><input type="checkbox" value="Coughing or sneezing"> Coughing or sneezing</label>
      <label><input type="checkbox" value="Breathing seems harder"> Breathing seems harder</label>
      <label><input type="checkbox" value="Skin redness / itching"> Skin redness / itching</label>
      <label><input type="checkbox" value="Eye discharge / redness"> Eye discharge / redness</label>
    </div>
    <label for="notes">Additional notes:</label>
    <textarea id="notes" placeholder="Describe what's going on"></textarea>
    <label for="photo">Photo (required):</label>
    <input type="file" id="photo" accept="image/*" required>
    <button type="submit">Run AI Scan</button>
  </form>
  <div id="result" class="result"></div>
  <h2>About PetScan AI</h2>
  <p>PetScan AI is an educational tool that helps pet parents think through what they're seeing at home. It uses AI to summarize your notes and photo into simple triage-style guidance.</p>
  <p><strong>What PetScan AI is not:</strong> It is not a veterinarian, does not provide a diagnosis, and does not replace an in-person exam.</p>
  <p><strong>Emergency situations:</strong> If your pet is in distress, contact a veterinarian or emergency clinic immediately.</p>
</main>
<footer>&copy; 2025 PetScan AI. All rights reserved.</footer>
<script>
  async function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const b64 = reader.result.split(',')[1];
        resolve(b64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
  document.getElementById('scan-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const scanType = document.getElementById('scan-type').value;
    const notes = document.getElementById('notes').value.trim();
    const fileInput = document.getElementById('photo');
    if (!fileInput.files.length) {
      alert('Please upload a photo.');
      return;
    }
    const file = fileInput.files[0];
    const imageBase64 = await toBase64(file);
    // gather selected concerns
    const concerns = Array.from(document.querySelectorAll('.concerns input:checked')).map(c => c.value);
    const combinedNotes = concerns.length ? 
      ('Common concerns: ' + concerns.join(', ') + (notes ? '. Additional notes: ' + notes : '')) :
      notes;
    // generate random user_id and pet_id for web
    const existingUserId = localStorage.getItem('petscan_user_id');
    let userId = existingUserId;
    if (!existingUserId) {
      userId = crypto.randomUUID();
      localStorage.setItem('petscan_user_id', userId);
    }
    const petId = crypto.randomUUID();
    const payload = {
      user_id: userId,
      pet_id: petId,
      species: '',
      notes: combinedNotes,
      image_url: '',
      image_base64: imageBase64,
      scan_type: scanType
    };
    const endpoint = `https://petscan-backend.onrender.com/webapi/v1/analyze/${scanType}`;
    try {
      const resp = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) throw new Error('Server error: ' + resp.status);
      const data = await resp.json();
      showResult(data);
    } catch (err) {
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
    }
  });
  function showResult(data) {
    const resultDiv = document.getElementById('result');
    let statusText = 'Monitor';
    let colorStyle = 'color:orange;';
    if (data.overall_status === 'normal') {
      statusText = 'Looks OK';
      colorStyle = 'color:green;';
    } else if (data.overall_status === 'needs_attention') {
      statusText = 'Needs Attention';
      colorStyle = 'color:red;';
    }
    let html = '<p><strong>Status:</strong> <span style="' + colorStyle + '">' + statusText + '</span></p>';
    html += '<p><strong>Summary:</strong> ' + (data.summary_text || 'No summary provided.') + '</p>';
    html += '<p><strong>Recommendation:</strong> ' + (data.recommendation_text || 'No recommendation provided.') + '</p>';
    if (Array.isArray(data.possible_conditions) && data.possible_conditions.length) {
      html += '<p><strong>Possible conditions (not a diagnosis):</strong></p><ul>';
      data.possible_conditions.forEach(c => {
        html += '<li>' + c + '</li>';
      });
      html += '</ul>';
    }
    if (data.disclaimer) {
      html += '<p style="font-size:smaller;color:#555;">' + data.disclaimer + '</p>';
    }
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = html;
  }
</script>
</body>
</html>
